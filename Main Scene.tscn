[gd_scene load_steps=18 format=2]

[ext_resource path="res://Raindrop.shader" type="Shader" id=1]
[ext_resource path="res://mesh/raindrop.tres" type="CapsuleMesh" id=2]
[ext_resource path="res://Main.gd" type="Script" id=3]
[ext_resource path="res://textures/dirt/1K-ground_dirt_3-specular.jpg" type="Texture" id=4]
[ext_resource path="res://textures/dirt/1K-ground_dirt_3-normal.jpg" type="Texture" id=5]
[ext_resource path="res://textures/ripple-normal.jpg" type="Texture" id=6]
[ext_resource path="res://textures/dirt/1K-ground_dirt_3-diffuse.jpg" type="Texture" id=7]
[ext_resource path="res://textures/dirt/1K-ground_dirt_3-displacement.jpg" type="Texture" id=8]
[ext_resource path="res://mesh/Shed.tscn" type="PackedScene" id=9]
[ext_resource path="res://Control.gd" type="Script" id=10]

[sub_resource type="ShaderMaterial" id=1]
render_priority = 1
shader = ExtResource( 1 )
shader_param/height = null
shader_param/gravity = 0.0
shader_param/init_vel = null
shader_param/amount = 0.0

[sub_resource type="PlaneMesh" id=2]
size = Vector2( 50, 50 )
subdivide_width = 64
subdivide_depth = 64

[sub_resource type="Shader" id=3]
code = "shader_type spatial;
render_mode specular_schlick_ggx;

uniform float height_scale = 0.5;

uniform sampler2D ground_albedo;
uniform sampler2D ground_normal_map : hint_normal;
uniform sampler2D ground_roughness;
uniform sampler2D rain_splash : hint_normal;
uniform sampler2D rain_wet_normal : hint_normal;
uniform sampler2D noise;
uniform sampler2D displacement;

varying vec2 tex_position;

uniform float blend_raining;

uniform vec3 world_up;

varying vec3 normal_vec;

float bias(float value,float power){
	return pow(value,power);
}

void vertex(){
	normal_vec = NORMAL;
	tex_position = VERTEX.xz / 2.0 + 0.5;
	float height = texture(displacement, tex_position).x;
	VERTEX.y += height * height_scale;
}

void fragment(){
	float fresnel = sqrt(1.0 - dot(NORMAL, VIEW));
	float offset = texture(noise,UV).r*0.5;
	vec3 water_travel_direction = world_up - normal_vec;
	vec2 compressed_water_travel_direction = water_travel_direction.xz;
	ROUGHNESS = (1.0 - blend_raining) + fresnel*0.1;
	METALLIC = bias(blend_raining,0.5)/2.0+0.3;
	SPECULAR = 1.0;
	float mix_factor = -((2.0*(0.5))/3.141592)*asin(sin((2.0*3.141592)*(TIME+0.25+offset)))+0.5;
	vec3 newnormal = mix(texture(rain_wet_normal,UV+compressed_water_travel_direction*mod(TIME+0.5+offset,1.0)).rgb,texture(rain_wet_normal,UV+compressed_water_travel_direction*mod(TIME+offset,1.0)).rgb,mix_factor);
	NORMALMAP = mix(texture(ground_normal_map,UV).rgb,newnormal,bias(blend_raining,0.4));
	ALBEDO = texture(ground_albedo,UV+(newnormal.xz*bias(blend_raining,8.0)/50.0)).rgb + fresnel*0.1;
	RIM = blend_raining / 10.0;
	
}"

[sub_resource type="OpenSimplexNoise" id=4]

[sub_resource type="NoiseTexture" id=5]
as_normalmap = true
noise = SubResource( 4 )

[sub_resource type="ShaderMaterial" id=6]
shader = SubResource( 3 )
shader_param/height_scale = 1.0
shader_param/blend_raining = 0.0
shader_param/world_up = null
shader_param/ground_albedo = ExtResource( 7 )
shader_param/ground_normal_map = ExtResource( 5 )
shader_param/ground_roughness = ExtResource( 4 )
shader_param/rain_splash = ExtResource( 6 )
shader_param/rain_wet_normal = ExtResource( 4 )
shader_param/noise = SubResource( 5 )
shader_param/displacement = ExtResource( 8 )

[sub_resource type="BoxShape" id=7]

[node name="Spatial" type="Spatial"]
script = ExtResource( 3 )
height = 100.0
speed = 10.0

[node name="Rain" type="Particles" parent="."]
transform = Transform( 1, 0, 0, 0, -4.37114e-08, -1, 0, 1, -4.37114e-08, 0, 0, 0 )
emitting = false
amount = 20000
visibility_aabb = AABB( -25, -25, -25, 50, 50, 50 )
process_material = SubResource( 1 )
draw_pass_1 = ExtResource( 2 )

[node name="Shed" parent="." instance=ExtResource( 9 )]

[node name="Floor" type="MeshInstance" parent="."]
mesh = SubResource( 2 )
material/0 = SubResource( 6 )

[node name="DirectionalLight" type="DirectionalLight" parent="."]
transform = Transform( 1, 0, 0, 0, 0.939693, 0.34202, 0, -0.34202, 0.939693, 0, 20.9959, 0 )

[node name="OmniLight" type="OmniLight" parent="."]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 15.0789, 0 )
omni_range = 57.4165

[node name="Camera2" type="Camera" parent="."]
transform = Transform( -4.37114e-08, -1, 1.19249e-08, 0, 1.19249e-08, 1, -1, 4.37114e-08, -5.21253e-16, 0, 43.8648, 0 )
projection = 1
size = 50.0

[node name="Control" type="KinematicBody" parent="."]
transform = Transform( 0.707107, 0, 0.707107, 0, 1, 0, -0.707107, 0, 0.707107, 18.3949, 17.9275, 19.309 )
script = ExtResource( 10 )

[node name="Camera" type="Camera" parent="Control"]
transform = Transform( 1, 0, 0, 0, 1, -5.96046e-08, 0, -5.96046e-08, 1, 0, 0, 0 )
current = true

[node name="CollisionShape" type="CollisionShape" parent="Control"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, -5.96046e-08, 1, 0, 0, 0 )
shape = SubResource( 7 )
